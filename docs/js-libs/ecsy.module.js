class SystemManager{constructor(e){this._systems=[],this._executeSystems=[],this.world=e,this.lastExecutedSystem=null}registerSystem(e,t){if(void 0!==this._systems.find(t=>t.constructor.name===e.name))return this;var s=new e(this.world,t);return s.init&&s.init(),s.order=this._systems.length,this._systems.push(s),s.execute&&(this._executeSystems.push(s),this.sortSystems()),this}sortSystems(){this._executeSystems.sort((e,t)=>e.priority-t.priority||e.order-t.order)}getSystem(e){return this._systems.find(t=>t instanceof e)}getSystems(){return this._systems}removeSystem(e){var t=this._systems.indexOf(e);~t&&this._systems.splice(t,1)}executeSystem(e,t,s){if(e.initialized&&e.canExecute()){let n=performance.now();e.execute(t,s),e.executeTime=performance.now()-n,this.lastExecutedSystem=e,e.clearEvents()}}stop(){this._executeSystems.forEach(e=>e.stop())}execute(e,t,s){this._executeSystems.forEach(n=>(s||n.enabled)&&this.executeSystem(n,e,t))}stats(){for(var e={numSystems:this._systems.length,systems:{}},t=0;t<this._systems.length;t++){var s=this._systems[t],n=e.systems[s.constructor.name]={queries:{}};for(var i in s.ctx)n.queries[i]=s.ctx[i].stats()}return e}}class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let s=this._listeners;void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var s=this._listeners[e];if(void 0!==s){var n=s.indexOf(t);-1!==n&&s.splice(n,1)}}dispatchEvent(e,t,s){this.stats.fired++;var n=this._listeners[e];if(void 0!==n)for(var i=n.slice(0),o=0;o<i.length;o++)i[o].call(this,t,s)}resetCounters(){this.stats.fired=this.stats.handled=0}}function e(e){return e.name}function t(t){var s=e(t);return s.charAt(0).toLowerCase()+s.slice(1)}function s(t){for(var s=[],n=0;n<t.length;n++){var i=t[n];if("object"==typeof i){var o="not"===i.operator?"!":i.operator;s.push(o+e(i.Component))}else s.push(e(i))}return s.sort().join("-")}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=s(e);for(var n=0;n<t._entities.length;n++){var i=t._entities[n];this.match(i)&&(i.queries.push(this),this.entities.push(i))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map(e=>e.name),not:this.NotComponents.map(e=>e.name)},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";var n=0;class Entity{constructor(e){this._world=e||null,this.id=n++,this._ComponentTypes=[],this._components={},this._componentsToRemove={},this.queries=[],this._ComponentTypesToRemove=[],this.alive=!1}getComponent(e,t){var s=this._components[e.name];return s||!0!==t||(s=this._componentsToRemove[e.name]),s}getRemovedComponent(e){return this._componentsToRemove[e.name]}getComponents(){return this._components}getComponentsToRemove(){return this._componentsToRemove}getComponentTypes(){return this._ComponentTypes}getMutableComponent(e){for(var t=this._components[e.name],s=0;s<this.queries.length;s++){var n=this.queries[s];n.reactive&&-1!==n.Components.indexOf(e)&&n.eventDispatcher.dispatchEvent(Query.prototype.COMPONENT_CHANGED,this,t)}return t}addComponent(e,t){return this._world.entityAddComponent(this,e,t),this}removeComponent(e,t){return this._world.entityRemoveComponent(this,e,t),this}hasComponent(e,t){return!!~this._ComponentTypes.indexOf(e)||!0===t&&this.hasRemovedComponent(e)}hasRemovedComponent(e){return!!~this._ComponentTypesToRemove.indexOf(e)}hasAllComponents(e){for(var t=0;t<e.length;t++)if(!this.hasComponent(e[t]))return!1;return!0}hasAnyComponents(e){for(var t=0;t<e.length;t++)if(this.hasComponent(e[t]))return!0;return!1}removeAllComponents(e){return this._world.entityRemoveAllComponents(this,e)}reset(){this.id=n++,this._world=null,this._ComponentTypes.length=0,this.queries.length=0,this._components={}}remove(e){return this._world.removeEntity(this,e)}}class ObjectPool{constructor(e,t){this.freeList=[],this.count=0,this.T=e,this.isObjectPool=!0;var s=null;arguments.length>1&&(s=Array.prototype.slice.call(arguments)).shift(),this.createElement=s?()=>new e(...s):()=>new e,void 0!==t&&this.expand(t)}aquire(){return this.freeList.length<=0&&this.expand(Math.round(.2*this.count)+1),this.freeList.pop()}release(e){e.reset(),this.freeList.push(e)}expand(e){for(var t=0;t<e;t++)this.freeList.push(this.createElement());this.count+=e}totalSize(){return this.count}totalFree(){return this.freeList.length}totalUsed(){return this.count-this.freeList.length}}class QueryManager{constructor(e){this._world=e,this._queries={}}onEntityRemoved(e){for(var t in this._queries){var s=this._queries[t];-1!==e.queries.indexOf(s)&&s.removeEntity(e)}}onEntityComponentAdded(e,t){for(var s in this._queries){var n=this._queries[s];~n.NotComponents.indexOf(t)&&~n.entities.indexOf(e)?n.removeEntity(e):~n.Components.indexOf(t)&&n.match(e)&&!~n.entities.indexOf(e)&&n.addEntity(e)}}onEntityComponentRemoved(e,t){for(var s in this._queries){var n=this._queries[s];~n.NotComponents.indexOf(t)&&!~n.entities.indexOf(e)&&n.match(e)?n.addEntity(e):~n.Components.indexOf(t)&&~n.entities.indexOf(e)&&!n.match(e)&&n.removeEntity(e)}}getQuery(e){var t=s(e),n=this._queries[t];return n||(this._queries[t]=n=new Query(e,this._world)),n}stats(){var e={};for(var t in this._queries)e[t]=this._queries[t].stats();return e}}class SystemStateComponent{}SystemStateComponent.isSystemStateComponent=!0;class EntityManager{constructor(e){this.world=e,this.componentsManager=e.componentsManager,this._entities=[],this._queryManager=new QueryManager(this),this.eventDispatcher=new EventDispatcher,this._entityPool=new ObjectPool(Entity),this.entitiesWithComponentsToRemove=[],this.entitiesToRemove=[],this.deferredRemovalEnabled=!0,this.numStateComponents=0}createEntity(){var e=this._entityPool.aquire();return e.alive=!0,e._world=this,this._entities.push(e),this.eventDispatcher.dispatchEvent(i,e),e}entityAddComponent(e,t,s){if(!~e._ComponentTypes.indexOf(t)){e._ComponentTypes.push(t),t.__proto__===SystemStateComponent&&this.numStateComponents++;var n=this.world.componentsManager.getComponentsPool(t).aquire();if(e._components[t.name]=n,s)if(n.copy)n.copy(s);else for(var i in s)n[i]=s[i];this._queryManager.onEntityComponentAdded(e,t),this.world.componentsManager.componentAddedToEntity(t),this.eventDispatcher.dispatchEvent(r,e,t)}}entityRemoveComponent(t,s,n){var i=t._ComponentTypes.indexOf(s);if(~i){if(this.eventDispatcher.dispatchEvent(h,t,s),n)this._entityRemoveComponentSync(t,s,i);else{0===t._ComponentTypesToRemove.length&&this.entitiesWithComponentsToRemove.push(t),t._ComponentTypes.splice(i,1),t._ComponentTypesToRemove.push(s);var o=e(s);t._componentsToRemove[o]=t._components[o],delete t._components[o]}this._queryManager.onEntityComponentRemoved(t,s),s.__proto__===SystemStateComponent&&(this.numStateComponents--,0!==this.numStateComponents||t.alive||t.remove())}}_entityRemoveComponentSync(s,n,i){s._ComponentTypes.splice(i,1);var o=t(n),r=e(n),h=s._components[r];delete s._components[r],this.componentsManager._componentPool[o].release(h),this.world.componentsManager.componentRemovedFromEntity(n)}entityRemoveAllComponents(e,t){let s=e._ComponentTypes;for(let n=s.length-1;n>=0;n--)s[n].__proto__!==SystemStateComponent&&this.entityRemoveComponent(e,s[n],t)}removeEntity(e,t){var s=this._entities.indexOf(e);if(!~s)throw new Error("Tried to remove entity not in list");e.alive=!1,0===this.numStateComponents&&(this.eventDispatcher.dispatchEvent(o,e),this._queryManager.onEntityRemoved(e),!0===t?this._releaseEntity(e,s):this.entitiesToRemove.push(e)),this.entityRemoveAllComponents(e,t)}_releaseEntity(e,t){this._entities.splice(t,1),e._world=null,this._entityPool.release(e)}removeAllEntities(){for(var e=this._entities.length-1;e>=0;e--)this.removeEntity(this._entities[e])}processDeferredRemoval(){if(this.deferredRemovalEnabled){for(let e=0;e<this.entitiesToRemove.length;e++){let t=this.entitiesToRemove[e],s=this._entities.indexOf(t);this._releaseEntity(t,s)}this.entitiesToRemove.length=0;for(let o=0;o<this.entitiesWithComponentsToRemove.length;o++){let r=this.entitiesWithComponentsToRemove[o];for(;r._ComponentTypesToRemove.length>0;){let o=r._ComponentTypesToRemove.pop();var s=t(o),n=e(o),i=r._componentsToRemove[n];delete r._componentsToRemove[n],this.componentsManager._componentPool[s].release(i),this.world.componentsManager.componentRemovedFromEntity(o)}}this.entitiesWithComponentsToRemove.length=0}}queryComponents(e){return this._queryManager.getQuery(e)}count(){return this._entities.length}stats(){var e={numEntities:this._entities.length,numQueries:Object.keys(this._queryManager._queries).length,queries:this._queryManager.stats(),numComponentPool:Object.keys(this.componentsManager._componentPool).length,componentPool:{},eventDispatcher:this.eventDispatcher.stats};for(var t in this.componentsManager._componentPool){var s=this.componentsManager._componentPool[t];e.componentPool[t]={used:s.totalUsed(),size:s.count}}return e}}const i="EntityManager#ENTITY_CREATE",o="EntityManager#ENTITY_REMOVED",r="EntityManager#COMPONENT_ADDED",h="EntityManager#COMPONENT_REMOVE";class DummyObjectPool{constructor(e){this.isDummyObjectPool=!0,this.count=0,this.used=0,this.T=e}aquire(){return this.used++,this.count++,new this.T}release(){this.used--}totalSize(){return this.count}totalFree(){return 1/0}totalUsed(){return this.used}}class ComponentManager{constructor(){this.Components={},this._componentPool={},this.numComponents={}}registerComponent(e){this.Components[e.name]||(this.Components[e.name]=e,this.numComponents[e.name]=0)}componentAddedToEntity(e){this.Components[e.name]||this.registerComponent(e),this.numComponents[e.name]++}componentRemovedFromEntity(e){this.numComponents[e.name]--}getComponentsPool(e){var s=t(e);return this._componentPool[s]||(e.prototype.reset?this._componentPool[s]=new ObjectPool(e):this._componentPool[s]=new DummyObjectPool(e)),this._componentPool[s]}}const a="0.2.1";class World{constructor(){if(this.componentsManager=new ComponentManager(this),this.entityManager=new EntityManager(this),this.systemManager=new SystemManager(this),this.enabled=!0,this.eventQueues={},"undefined"!=typeof CustomEvent){var e=new CustomEvent("ecsy-world-created",{detail:{world:this,version:a}});window.dispatchEvent(e)}this.lastTime=performance.now()}registerComponent(e){return this.componentsManager.registerComponent(e),this}registerSystem(e,t){return this.systemManager.registerSystem(e,t),this}getSystem(e){return this.systemManager.getSystem(e)}getSystems(){return this.systemManager.getSystems()}execute(e,t){if(!e){let t=performance.now();e=t-this.lastTime,this.lastTime=t}this.enabled&&(this.systemManager.execute(e,t),this.entityManager.processDeferredRemoval())}stop(){this.enabled=!1}play(){this.enabled=!0}createEntity(){return this.entityManager.createEntity()}stats(){this.entityManager.stats(),this.systemManager.stats()}}class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var s in this.constructor.queries){var n=this.constructor.queries[s],i=n.components;if(!i||0===i.length)throw new Error("'components' attribute can't be empty in a query");var o=this.world.entityManager.queryComponents(i);this._queries[s]=o,!0===n.mandatory&&this._mandatoryQueries.push(o),this.queries[s]={results:o.entities};const e={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};n.listen&&["added","removed","changed"].forEach(t=>{if(n.listen[t]){let i=n.listen[t];if("changed"===t){if(o.reactive=!0,!0===i){let e=this.queries[s][t]=[];o.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(i)){let e=this.queries[s][t]=[];o.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(t,s)=>{-1!==i.indexOf(s.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let n=this.queries[s][t]=[];o.eventDispatcher.addEventListener(e[t],e=>{-1===n.indexOf(e)&&n.push(e)})}}})}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let s in t){let n=this.queries[s],i=t[s],o=e.queries[s]={key:this._queries[s].key};if(o.mandatory=!0===i.mandatory,o.reactive=i.listen&&(!0===i.listen.added||!0===i.listen.removed||!0===i.listen.changed||Array.isArray(i.listen.changed)),o.reactive){o.listen={},["added","removed","changed"].forEach(e=>{n[e]&&(o.listen[e]={entities:n[e].length})})}}}return e}}export{System,World};
