!function(e,t){"use strict";function n(t){return e.Angle.FromDegrees(t).radians()}function r(e){return e.world}function i(e){e.object&&e.object.dispose()}function s(e){return r(e).getSystems().find(e=>e.engine)}function o(e,t){return s(e).getScene(t)}function a(e,t){return s(e).getAssetManager(t)}function c(e){return s(e).activeCameraEntity}function h(t){return new e.Vector3(t.x,t.y,t.z)}function l(t){return new e.Vector3(n(t.x),n(t.y),n(t.z))}function d(e){return{x:e.x,y:e.y,z:e.z}}function u(e){return{x:e.x,y:e.y,z:e.z}}function m(t){return e.Color3.FromHexString(t)}function p(t){return e.Color4.FromHexString(t)}function g(e,t,n){for(let r in t){let s=t[r];n.addTextureTask(r,s.url).onSuccess=t=>{let n=t.texture;for(let e in s)"url"!==e&&(n[e]=s[e]);let o=`${r}Texture`,a=e.object;a[o]&&i(a[o]),a[o]=n}}n.load(),n.reset()}function f(e){let t=e.getComponents(),n=[];for(let e in t)t[e].object&&n.push(t[e]);return n}function y(e,t){t.forEach(t=>{let n=t.object;n.position&&(n.position=h(e.position)),n.rotation&&(n.rotation=l(e.rotation)),n.scaling&&(n.scaling=h(e.scale))})}function S(e,t){e.object[t]=e[t]}function C(e,t){e.object[t]=h(e[t])}function b(e,t,n){return e&&t&&n?{x:e,y:t,z:n}:{x:0,y:0,z:0}}class Transform{constructor(){this.position=b(),this.rotation=b(),this.scale=b(1,1,1),this.updateObjects=!0}}class Camera{constructor(){this.options={}}}var _,x,M,E,v,j,T;!function(e){e.Box="Box",e.Plane="Plane",e.Sphere="Sphere",e.Ground="Ground"}(_||(_={}));class Mesh{constructor(){this.type=_.Box,this.options={}}}!function(e){e.Point="Point",e.Directional="Directional",e.Spot="Spot",e.Hemispheric="Hemispheric"}(x||(x={}));class Light{constructor(){this.type=x.Hemispheric,this.direction=b()}}class Material{constructor(){var e;this.color=e?{diffuse:e}:{diffuse:"#ffffff"}}}!function(e){e.Point="Point",e.Box="Box",e.Sphere="Sphere",e.DirectedSphere="DirectedSphere",e.Hemisphere="Hemisphere",e.Cylinder="Cylinder",e.DirectedCylinder="DirectedCylinder",e.Cone="Cone"}(M||(M={}));class Particle{constructor(){this.type=M.Point,this.capacity=100,this.emitter=b(),this.direction1=b(),this.direction2=b(10,10,10),this.minEmitBox=b(),this.maxEmitBox=b()}}!function(e){e.Babylon="Babylon"}(E||(E={}));class Asset{constructor(){this.type=E.Babylon}}!function(e){e.Keyboard="Keyboard",e.VrRight="VrRight",e.VrLeft="VrLeft"}(v||(v={}));class Input{constructor(){this.type=v.VrRight}}class GameSystem extends t.System{constructor(){super(...arguments),this._scenes=new Map,this._assetManagers=new Map,this._isRendering=!1}get activeSceneName(){return this._activeSceneName}get activeCameraEntity(){return this._activeCameraEntity}init(){this._render=this._render.bind(this)}execute(){this.queries.camera.added.forEach(t=>{let n=t.getComponent(Camera),r=this.getScene(n.sceneName);n.object=new e.VRExperienceHelper(r,n.options),r===this._activeScene&&(this._activeCameraEntity=t,this._isRendering=!0)}),this.queries.camera.removed.forEach(e=>{let t=e.getComponent(Camera);i(t),this.getScene(t.sceneName)===this._activeScene&&(this._isRendering=!1)})}start(t,n,r,i){return this.engine=new e.Engine(t,n,r,i),this.engine.runRenderLoop(this._render),this}addScene(t,n){let r=new e.Scene(this.engine,n),i=new e.AssetsManager(r);return i.useDefaultLoadingScreen=!1,this._scenes.set(t,r),this._assetManagers.set(t,i),1===this.engine.scenes.length&&(this._activeScene=r,this._activeSceneName=t),this}removeScene(e){return e!==this.activeSceneName&&this.getScene(e).dispose(),this}switchScene(e,t){return this.getScene(e)&&(this._activeScene=this.getScene(e),this._activeSceneName=e,this._activeCameraEntity=t),this}getScene(e){return e?this._scenes.get(e):this._activeScene}getAssetManager(e){let t=this.activeSceneName;return e&&(t=e),this._assetManagers.get(t)}_render(){r(this).execute(this.engine.getDeltaTime(),performance.now()),this._isRendering&&r(this).enabled&&this._activeScene.render()}}GameSystem.queries={camera:{components:[Camera],listen:{added:!0,removed:!0}}};class TransformSystem extends t.System{init(){window.addEventListener("load",()=>{this.queries.object.results.forEach(e=>{e.getComponent(Transform).updateObjects&&y(e.getComponent(Transform),f(e))})})}execute(){this.queries.object.changed.forEach(e=>{e.getComponent(Transform).updateObjects&&y(e.getComponent(Transform),f(e))})}}TransformSystem.queries={object:{components:[Transform],listen:{changed:[Transform]}}};class MeshSystem extends t.System{execute(){this.queries.mesh.added.forEach(t=>{let n=t.getComponent(Mesh);n.object=e.MeshBuilder[`Create${n.type}`].call(this,n.type,n.options,o(this,n.sceneName))}),this.queries.mesh.changed.forEach(e=>{let t=e.getMutableComponent(Mesh);for(let e in t)S(t,e)}),this.queries.mesh.removed.forEach(e=>{i(e.getComponent(Mesh))})}}MeshSystem.queries={mesh:{components:[Mesh],listen:{added:!0,removed:!0,changed:[Mesh]}}};class LightSystem extends t.System{execute(){this.queries.light.added.forEach(t=>{let r=t.getComponent(Light),i=h(r.direction),s=o(this,r.sceneName);switch(r.type){case x.Point:r.object=new e.PointLight(r.type,e.Vector3.Zero(),s);break;case x.Directional:r.object=new e.DirectionalLight(r.type,i,s);break;case x.Spot:r.object=new e.SpotLight(r.type,e.Vector3.Zero(),i,n(r.angle),r.exponent,s);break;default:r.object=new e.HemisphericLight(x.Hemispheric,i,s)}this._updateLight(r)}),this.queries.light.changed.forEach(e=>{this._updateLight(e.getComponent(Light))}),this.queries.light.removed.forEach(e=>{i(e.getComponent(Light))})}_updateLight(e){for(let t in e)switch(t){case"direction":C(e,t);break;case"color":this._updateColor(e,e.color);break;default:S(e,t)}}_updateColor(e,t){for(let n in t)e.object[n]=m(t[n])}}LightSystem.queries={light:{components:[Light],listen:{added:!0,removed:!0,changed:[Light]}}};class MaterialSystem extends t.System{execute(){this.queries.meshMaterial.added.forEach(t=>{let n=t.getComponent(Material);n.object=new e.StandardMaterial(n.color.diffuse,o(this,n.sceneName)),this._updateMaterial(n),t.getComponent(Mesh).object.material=n.object}),this.queries.meshMaterial.changed.forEach(e=>{this._updateMaterial(e.getComponent(Material))}),this.queries.meshMaterial.removed.forEach(e=>{i(e.getComponent(Material)),e.getComponent(Mesh).object.material=null})}_updateMaterial(e){for(let t in e)switch(t){case"color":this._updateColor(e,e.color);break;case"texture":g(e,e.texture,a(this,e.sceneName));break;default:S(e,t)}}_updateColor(e,t){for(let n in t)e.object[`${n}Color`]=m(t[n])}}MaterialSystem.queries={meshMaterial:{components:[Mesh,Material],listen:{added:!0,removed:!0,changed:[Material]}}};class ParticleSystem extends t.System{execute(){this.queries.particle.added.forEach(t=>{let n=t.getComponent(Particle);n.object=new e.ParticleSystem(n.type,n.capacity,o(this,n.sceneName));let r=n.object;switch(n.type){case M.Point:r.createPointEmitter(h(n.direction1),h(n.direction2));break;case M.Box:r.createBoxEmitter(h(n.direction1),h(n.direction2),h(n.minEmitBox),h(n.maxEmitBox));break;case M.Sphere:r.createSphereEmitter(n.radius,n.radiusRange);break;case M.DirectedSphere:r.createDirectedSphereEmitter(n.radius,h(n.direction1),h(n.direction2));break;case M.Hemisphere:r.createHemisphericEmitter(n.radius,n.radiusRange);break;case M.Cylinder:r.createCylinderEmitter(n.radius,n.height,n.radiusRange,Math.random());break;case M.DirectedCylinder:r.createDirectedCylinderEmitter(n.radius,n.height,n.radiusRange,h(n.direction1),h(n.direction2));break;case M.Cone:r.createConeEmitter(n.radius,n.angle)}this._updateParticle(n),r.start()}),this.queries.particle.changed.forEach(e=>{this._updateParticle(e.getComponent(Particle))}),this.queries.particle.removed.forEach(e=>{let t=e.getComponent(Particle);t.object.stop(),i(t)})}_updateParticle(e){for(let t in e)switch(t){case"emitter":case"direction1":case"direction2":case"minEmitBox":case"maxEmitBox":C(e,t);break;case"texture":g(e,e.texture,a(this,e.sceneName));break;case"color":this._updateColor(e,e.color);break;default:S(e,t)}}_updateColor(e,t){for(let n in t)e.object[n]=p(t[n])}}ParticleSystem.queries={particle:{components:[Particle],listen:{added:!0,removed:!0,changed:[Particle]}}};class AssetSystem extends t.System{execute(){this.queries.asset.added.forEach(e=>{let t=e.getComponent(Asset),n=a(this,t.sceneName);t.type,this._loadBabylon(e.getComponent(Transform),t,n),n.load(),n.reset()}),this.queries.asset.removed.forEach(e=>{i(e.getComponent(Asset))})}_loadBabylon(e,t,n){let r=t.url.lastIndexOf("/")+1;n.addMeshTask(E.Babylon,"",t.url.substring(0,r),t.url.substring(r,t.url.length)).onSuccess=n=>{t.object=n.loadedMeshes[0],e&&y(e,[t])}}}AssetSystem.queries={asset:{components:[Asset],listen:{added:!0,removed:!0}}},function(e){e.onMainButton="onMainButton",e.onPad="onPad",e.onSecondaryButton="onSecondaryButton",e.onTrigger="onTrigger"}(j||(j={})),function(e){e.onPadValues="onPadValues"}(T||(T={}));class InputSystem extends t.System{constructor(){super(...arguments),this._isControllerConntected=!1}execute(){this.queries.input.added.forEach(e=>{let t=e.getComponent(Input);switch(t.type){case v.Keyboard:t.onKey&&(window.addEventListener("keydown",e=>t.onKey.call(t,e.key,!0,!1)),window.addEventListener("keyup",e=>t.onKey.call(t,e.key,!1,!0)));break;default:e.hasComponent(Transform)&&(e.getMutableComponent(Transform).updateObjects=!1)}}),this.queries.input.results.forEach(e=>{let t=c(this).getComponent(Camera).object.webVRCamera.controllers,n=e.getMutableComponent(Input);t.length>0&&(this._isControllerConntected?this._updateObjectsTransform(e,n.object,e.getMutableComponent(Transform)):this._initVRController(n,t))})}_initVRController(e,t){e.type===v.VrLeft?e.object=this._getVRController(t,"left"):e.object=this._getVRController(t,"right"),this._bindControllerBehaviours(e),this._isControllerConntected=!0}_getVRController(e,t){return e.find(e=>e.hand===t)}_bindControllerBehaviours(e){for(let t in e)e[t]&&(t in j&&e.object[`${t}StateChangedObservable`].add(n=>{e[t].call(e,n.pressed,n.touched,n.value)}),t in T&&e.object[`${t}ChangedObservable`].add(n=>{e[t].call(e,n.x,n.y)}))}_updateObjectsTransform(e,t,n){n&&f(e).filter(e=>!(e instanceof Input)).forEach(e=>{let r=t.devicePosition,i=t.deviceRotationQuaternion.toEulerAngles(),s=e.object;s.position&&(s.position=r),s.rotation&&(s.rotation=i),s.scaling&&(s.scaling=h(n.scale)),n.position=d(r),n.rotation=u(i)})}}InputSystem.queries={input:{components:[Input],listen:{added:!0}}};var w=Object.freeze({__proto__:null,degreeToRadians:n,getAssetManager:a,getCamera:c,getScene:o,hexToColor3:m,hexToColor4:p,radiansToDegree:function(t){return e.Angle.FromRadians(t).degrees()},vector3ToXyz:d,vector3ToXyzDegree:u,xyzToVector3:h,xyzToVector3Radians:l,GameSystem:GameSystem,TransformSystem:TransformSystem,MeshSystem:MeshSystem,LightSystem:LightSystem,MaterialSystem:MaterialSystem,ParticleSystem:ParticleSystem,AssetSystem:AssetSystem,InputSystem:InputSystem,Transform:Transform,Camera:Camera,get MeshTypes(){return _},Mesh:Mesh,get LightTypes(){return x},Light:Light,Material:Material,get ParticleTypes(){return M},Particle:Particle,get AssetTypes(){return E},Asset:Asset,get InputTypes(){return v},Input:Input});window.EB=w}(BABYLON,ECSY);
